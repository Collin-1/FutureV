<script>
    (function () {
        const list = document.querySelector('[data-image-list]');
        const addButton = document.querySelector('[data-add-image]');
        if (!list || !addButton) {
            return;
        }

        const reindex = () => {
            list
                .querySelectorAll('[data-image-item]')
                .forEach((item, index) => {
                    const indexField = item.querySelector('input[name="Images.Index"]');
                    if (indexField) {
                        indexField.value = index;
                    }

                    item.querySelectorAll('[id]').forEach(element => {
                        if (element.id.includes('__')) {
                            element.id = element.id.replace(/Images_\d+__/g, `Images_${index}__`);
                        }
                    });

                    item.querySelectorAll('[name]').forEach(element => {
                        if (element.name.includes(']')) {
                            element.name = element.name.replace(/Images\[\d+\]/g, `Images[${index}]`);
                        }
                    });

                    item.querySelectorAll('label[for]').forEach(label => {
                        if (label.htmlFor.includes('__')) {
                            label.htmlFor = label.htmlFor.replace(/Images_\d+__/g, `Images_${index}__`);
                        }
                    });
                });
        };

        const template = (index) => `
            <div class="border p-3 rounded position-relative" data-image-item>
                <input type="hidden" name="Images.Index" value="${index}" />
                <div class="mb-2">
                    <label class="form-label" for="Images_${index}__ViewAngle">View Angle</label>
                    <input class="form-control" type="text" id="Images_${index}__ViewAngle" name="Images[${index}].ViewAngle" />
                </div>
                <div class="mb-2">
                    <label class="form-label" for="Images_${index}__ImageUrl">Image URL</label>
                    <input class="form-control" type="url" id="Images_${index}__ImageUrl" name="Images[${index}].ImageUrl" />
                </div>
                <div class="mb-2">
                    <label class="form-label" for="Images_${index}__Description">Description</label>
                    <input class="form-control" type="text" id="Images_${index}__Description" name="Images[${index}].Description" />
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" data-remove-image>Remove</button>
            </div>`;

        addButton.addEventListener('click', function () {
            const nextIndex = list.querySelectorAll('[data-image-item]').length;
            list.insertAdjacentHTML('beforeend', template(nextIndex));
            reindex();
        });

        list.addEventListener('click', function (event) {
            const target = event.target;
            if (target.matches('[data-remove-image]')) {
                target.closest('[data-image-item]').remove();
                reindex();
            }
        });

        reindex();
    })();
</script>
